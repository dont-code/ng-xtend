name: Deploy Apps
on:
  workflow_dispatch:
    inputs:
      next:
        description: Is it a dev / next release ?
        required: true
        type: boolean
      deploy:
        description: Deploy to public website?
        required: true
        type: boolean
      branch:
        description: Deploy from which branch ?
        required: true
        type: string
        default: 'main'
jobs:
  build:
    env:
      branch: ${{ inputs.branch }}
      stage: ${{ inputs.next == true && 'next' || 'latest' }}
      build: ${{ inputs.next == true && 'next' || 'production' }}
      ELECTRON_EXTRA_LAUNCH_ARGS: '--disable-gpu'

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ env.branch }}
          token: ${{secrets.DONTCODE_ACTIONS_TOKEN}}

      - name: Git config user
        uses: snow-actions/git-config-user@v1.0.0
        with:
          name: Dont-code
          email: developer@dont-code.net
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'
      - name: Install
        run: |
          node common/scripts/install-run-rush.js install
      - name: Build
        run: |
          node common/scripts/install-run-rush.js build-deploy-${{ env.stage }}
      - name: Prepare files to deploy
        run: |
          mkdir -p ./to-deploy/${{env.stage}}
          mv ./dist/${{env.stage}}/plugin-tester/browser ./to-deploy/${{env.stage}}
          mv ./to-deploy/${{env.stage}}/browser ./to-deploy/${{env.stage}}/plugin-tester 
          mv ./dist/${{env.stage}}/host/browser ./to-deploy/${{env.stage}}
          mv ./to-deploy/${{env.stage}}/browser ./to-deploy/${{env.stage}}/host 
          mv ./dist/${{env.stage}}/sample-plugin/browser ./to-deploy/${{env.stage}}
          mv ./to-deploy/${{env.stage}}/browser ./to-deploy/${{env.stage}}/sample-plugin 
          mv ./dist/${{env.stage}}/default-plugin/browser ./to-deploy/${{env.stage}}
          mv ./to-deploy/${{env.stage}}/browser ./to-deploy/${{env.stage}}/default-plugin 
          mv ./dist/${{env.stage}}/intl-plugin/browser ./to-deploy/${{env.stage}}
          mv ./to-deploy/${{env.stage}}/browser ./to-deploy/${{env.stage}}/intl-plugin 
          mv ./dist/${{env.stage}}/web-plugin/browser ./to-deploy/${{env.stage}}
          mv ./to-deploy/${{env.stage}}/browser ./to-deploy/${{env.stage}}/web-plugin 
          mv ./dist/${{env.stage}}/finance-plugin/browser ./to-deploy/${{env.stage}}
          mv ./to-deploy/${{env.stage}}/browser ./to-deploy/${{env.stage}}/finance-plugin 
          mv ./dist/${{env.stage}}/agenda-plugin/browser ./to-deploy/${{env.stage}}
          mv ./to-deploy/${{env.stage}}/browser ./to-deploy/${{env.stage}}/agenda-plugin
      - name: Deploy to test.dont-code.net apps with ${{env.stage}}
        if: inputs.deploy == true
        uses: wlixcc/SFTP-Deploy-Action@v1.2.6
        with:
          username: ${{secrets.DONTCODE_APPS_WEBSITE_USER}}
          password: ${{secrets.DONTCODE_APPS_WEBSITE_PASSWORD}}
          local_path: './to-deploy/${{env.stage}}/*'
          remote_path: '/www/${{env.stage}}'
          server: 'test.${{secrets.DONTCODE_WEBSITE_HOST}}'
          port: ${{secrets.DONTCODE_WEBSITE_SSH_PORT}}
          sftp_only: 'true'
          delete_remote_files: 'false'
